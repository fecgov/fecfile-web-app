<p-toast></p-toast>
<h1>{{ transaction?.transactionType?.title }}</h1>
<h4 class="read-only-tag subtitle" *ngIf="!isEditable">READ ONLY</h4>
<p class="group-description">{{ transactionType?.description }}</p>
<p-accordion [activeIndex]="accordionActiveIndex">
  <p-accordionTab>
    <ng-template pTemplate="header">
      <strong>{{ transactionType?.accordionTitle }}:</strong>
      <p style="font-weight: normal">
        {{ transactionType?.accordionSubText }}
      </p></ng-template
    >
    <div class="p-fluid">
      <h2 *ngIf="transactionType?.formTitle">
        {{ transactionType?.formTitle }}
      </h2>
      <h3>{{ transactionType?.contactTitle }}</h3>
      <form id="form" [formGroup]="form" [ngClass]="{ 'ng-submitted': formSubmitted }">
        <div class="grid" *ngIf="isEditable">
          <div class="col-12">
            <label for="entity_type">{{ transactionType?.contactLookupLabel }}</label>
            <app-transaction-contact-lookup
              [form]="form"
              [formSubmitted]="formSubmitted"
              [contactTypeOptions]="contactTypeOptions"
              [contactTypeFormControl]="$any(form).controls['entity_type']"
              selectedContactFormControlName="contact_1"
              [contactTypeReadOnly]="contactTypeOptions.length === 1"
              (contactSelect)="onContactLookupSelect($event)"
            >
            </app-transaction-contact-lookup>
          </div>
        </div>
        <ng-container *ngIf="transaction?.contact_1">
          <ng-container
            *ngIf="[ContactTypes.ORGANIZATION, ContactTypes.COMMITTEE].includes(form.get('entity_type')?.value)"
          >
            <app-committee-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
              [entityRole]="getEntityType() === ContactTypes.ORGANIZATION ? 'ORGANIZATION' : 'COMMITTEE'"
              [includeFecId]="true"
            ></app-committee-input>
          </ng-container>
          <ng-container *ngIf="getEntityType() === ContactTypes.INDIVIDUAL">
            <app-name-input [form]="form" [formSubmitted]="formSubmitted" [templateMap]="templateMap"></app-name-input>
          </ng-container>
          <p-divider></p-divider>
          <h3>Address</h3>
          <app-address-input
            [form]="form"
            [formSubmitted]="formSubmitted"
            [templateMap]="templateMap"
          ></app-address-input>
          <p-divider></p-divider>
          <ng-container *ngIf="transactionType?.hasEmployeeFields() && getEntityType() === ContactTypes.INDIVIDUAL">
            <h3>Employer</h3>
            <app-employer-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
            ></app-employer-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="transaction?.transactionType?.showStandardAmount">
            <h3>{{ transaction?.transactionType?.amountInputHeader }}</h3>
            <app-amount-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
              [negativeAmountValueOnly]="!!transaction?.transactionType?.negativeAmountValueOnly"
              [showAggregate]="!!transaction?.transactionType?.showAggregate"
              [transaction]="transaction"
              [memoCodeCheckboxLabel]="(memoCodeCheckboxLabel$ | async)!"
            ></app-amount-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="transactionType?.hasLoanFinanceFields()">
            <h3>Loan information</h3>
            <app-loan-info-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
              [readonly]="false"
              [transaction]="transaction"
            ></app-loan-info-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="transactionType?.hasLoanTermsFields()">
            <h3>Terms</h3>
            <app-loan-terms-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
            ></app-loan-terms-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="transactionType?.hasCandidateInformation()">
            <h3>Committee/Candidate Information</h3>
            <app-committee-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
              entityRole="COMMITTEE"
              [includeFecId]="true"
              [readonly]="true"
            ></app-committee-input>
            <app-transaction-contact-lookup
              [form]="form"
              [formSubmitted]="formSubmitted"
              [contactTypeOptions]="candidateContactTypeOption"
              [contactTypeFormControl]="candidateContactTypeFormControl"
              selectedContactFormControlName="contact_2"
              [contactTypeReadOnly]="true"
              (contactSelect)="onSecondaryContactLookupSelect($event)"
            ></app-transaction-contact-lookup>
            <ng-container *ngIf="transaction?.contact_2">
              <app-candidate-input
                [form]="form"
                [formSubmitted]="formSubmitted"
                [templateMap]="templateMap"
              ></app-candidate-input>
            </ng-container>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="transactionType?.hasElectionInformation()">
            <h3>Election Information</h3>
            <app-election-input
              [form]="form"
              [formSubmitted]="formSubmitted"
              [templateMap]="templateMap"
            ></app-election-input>
            <p-divider></p-divider>
          </ng-container>
          <h3>Additional information</h3>
          <app-additional-info-input
            [form]="form"
            [formSubmitted]="formSubmitted"
            [templateMap]="templateMap"
            [transaction]="transaction"
            [descriptionIsSystemGenerated]="isDescriptionSystemGenerated(transaction?.transactionType)"
            [purposeDescriptionLabel]="purposeDescriptionLabel"
            [purposeDescriptionPrefix]="transaction?.transactionType?.purposeDescriptionPrefix"
          ></app-additional-info-input>
          <ng-container *ngIf="isEditable">
            <p-divider></p-divider>
            <ng-template ngFor let-navigationControl [ngForOf]="getInlineControls()">
              <div class="grid">
                <div class="col-4">
                  <app-navigation-control
                    [navigationControl]="navigationControl"
                    [transaction]="transaction"
                    (navigate)="handleNavigate($event)"
                  ></app-navigation-control>
                </div>
              </div>
            </ng-template>
            <p-divider></p-divider>
          </ng-container>
          <div class="grid" style="flex-direction: row-reverse">
            <p style="font-style: italic">{{ transactionType?.footer }}</p>
          </div>
        </ng-container>
      </form>
    </div>
  </p-accordionTab>

  <p-accordionTab>
    <ng-template pTemplate="header">
      <strong>{{ childTransactionType?.accordionTitle }}:</strong>
      <p style="font-weight: normal">
        {{ childTransactionType?.accordionSubText }}
      </p></ng-template
    >
    <div class="p-fluid">
      <h2>{{ childTransaction?.transactionType?.title }}</h2>
      <p *ngIf="childTransactionType?.description">
        <em>{{ childTransactionType?.description }}</em>
      </p>
      <h3>{{ childTransactionType?.contactTitle }}</h3>
      <form id="childForm" [formGroup]="childForm" [ngClass]="{ 'ng-submitted': formSubmitted }">
        <div class="grid" *ngIf="isEditable && !useParentContact">
          <div class="col-12">
            <div class="field">
              <label for="entity_type">ENTITY TYPE</label>
              <app-transaction-contact-lookup
                [form]="form"
                [formSubmitted]="formSubmitted"
                [contactTypeOptions]="childContactTypeOptions"
                [contactTypeFormControl]="$any(childForm).controls['entity_type']"
                selectedContactFormControlName="contact_1"
                [contactTypeReadOnly]="childContactTypeOptions.length === 1"
                (contactSelect)="childOnContactLookupSelect($event)"
              >
              </app-transaction-contact-lookup>
            </div>
          </div>
        </div>
        <ng-container *ngIf="childTransaction?.contact_1">
          <ng-container
            *ngIf="[ContactTypes.ORGANIZATION, ContactTypes.COMMITTEE].includes(form.get('entity_type')?.value)"
          >
            <app-committee-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
              [entityRole]="getEntityType() === ContactTypes.ORGANIZATION ? 'ORGANIZATION' : 'COMMITTEE'"
              [includeFecId]="true"
            ></app-committee-input>
          </ng-container>
          <ng-container *ngIf="childForm.get('entity_type')?.value === ContactTypes.INDIVIDUAL">
            <app-name-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
            ></app-name-input>
          </ng-container>
          <p-divider></p-divider>
          <h3>Address</h3>
          <app-address-input
            [form]="childForm"
            [formSubmitted]="formSubmitted"
            [templateMap]="childTemplateMap"
            [stateOptions]="stateOptions"
          ></app-address-input>
          <p-divider></p-divider>
          <ng-container
            *ngIf="
              childTransactionType?.hasEmployeeFields() &&
              childForm.get('entity_type')?.value === ContactTypes.INDIVIDUAL
            "
          >
            <h3>Employer</h3>
            <app-employer-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
            ></app-employer-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="childTransactionType?.hasCandidateInformation()">
            <h3>Committee/Candidate Information</h3>
            <app-committee-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
              entityRole="COMMITTEE"
              [includeFecId]="true"
              [readonly]="true"
            ></app-committee-input>
            <app-transaction-contact-lookup
              [form]="form"
              [formSubmitted]="formSubmitted"
              [contactTypeOptions]="candidateContactTypeOption"
              [contactTypeFormControl]="candidateContactTypeFormControl"
              selectedContactFormControlName="contact_2"
              [contactTypeReadOnly]="true"
              (contactSelect)="childOnSecondaryContactLookupSelect($event)"
            ></app-transaction-contact-lookup>
            <ng-container *ngIf="childTransaction?.contact_2">
              <app-candidate-input
                [form]="childForm"
                [formSubmitted]="formSubmitted"
                [templateMap]="childTemplateMap"
              ></app-candidate-input>
            </ng-container>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="childTransactionType?.hasElectionInformation()">
            <h3>Election Information</h3>
            <app-election-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
            ></app-election-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="childTransaction?.transactionType?.showStandardAmount">
            <h3>{{ childTransaction?.transactionType?.amountInputHeader }}</h3>
            <app-amount-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
              [contributionAmountReadOnly]="true"
              [negativeAmountValueOnly]="!!childTransaction?.transactionType?.negativeAmountValueOnly"
              [showAggregate]="!!childTransaction?.transactionType?.showAggregate"
              [transaction]="childTransaction"
              [memoCodeCheckboxLabel]="(childMemoCodeCheckboxLabel$ | async)!"
            ></app-amount-input>
            <p-divider></p-divider>
          </ng-container>
          <ng-container *ngIf="childTransactionType?.hasLoanFinanceFields()">
            <h3>Loan information</h3>
            <app-loan-info-input
              [form]="childForm"
              [formSubmitted]="formSubmitted"
              [templateMap]="childTemplateMap"
              [readonly]="false"
              [transaction]="childTransaction"
            ></app-loan-info-input>
            <p-divider></p-divider>
          </ng-container>
          <h3>Additional information</h3>
          <app-additional-info-input
            [form]="childForm"
            [formSubmitted]="formSubmitted"
            [templateMap]="childTemplateMap"
            [transaction]="transaction"
            [descriptionIsSystemGenerated]="isDescriptionSystemGenerated(childTransaction?.transactionType)"
            [purposeDescriptionLabel]="childPurposeDescriptionLabel"
            [purposeDescriptionPrefix]="transaction?.transactionType?.purposeDescriptionPrefix"
          ></app-additional-info-input>
        </ng-container>
      </form>
    </div>
  </p-accordionTab>
</p-accordion>

<div class="p-fluid">
  <app-navigation-control-bar
    [navigationControls]="getNavigationControls()"
    [transaction]="transaction"
    (navigate)="handleNavigate($event)"
    [class]="isEditable ? '' : 'flex-center'"
  ></app-navigation-control-bar>
</div>

<p-confirmDialog key="dialog" [style]="{ width: '450px' }"></p-confirmDialog>
<p-confirmDialog key="childDialog" [style]="{ width: '450px' }"></p-confirmDialog>
