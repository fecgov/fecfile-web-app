# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# See: https://circleci.com/docs/2.0/orb-intro/
orbs:
  browser-tools: circleci/browser-tools@2.2.1
  node: circleci/node@7.1.1
  python: circleci/python@3.2.0

# Reusable Commands see https://circleci.com/docs/reference/reusing-config/
# commands:
#   spin-up-api-containers:
#     description: "Setup and start fecfile-web-api for E2E tests"
#     steps:
#       - setup_remote_docker:
#           docker_layer_caching: false
#       - run:
#           name: clone fecfile-web-api
#           command: |
#             rm -rf fecfile-web-api
#             git clone https://github.com/fecgov/fecfile-web-api.git
#           working_directory: ~/project
#       - run:
#           name: use redis
#           command: |
#             export MOCK_OPENFEC=REDIS
#             echo $MOCK_OPENFEC
#       - run:
#           name: start fecfile-web-api
#           command: |
#             git checkout ${CIRCLE_BRANCH}
#             docker-compose down
#             DB_DOCKERFILE="Dockerfile-e2e" \
#             WORKER_DOCKERFILE="Worker_Dockerfile-e2e" \
#             API_DOCKERFILE="Dockerfile-e2e" \
#             FECFILE_TEST_DB_NAME="postgres" \
#             DJANGO_SECRET_KEY=${E2E_DJANGO_SECRET_KEY} \
#             DATABASE_URL=${E2E_DATABASE_URL} \
#             FEC_API=${E2E_FEC_API} \
#             FEC_API_KEY=${E2E_FEC_API_KEY} \
#             MOCK_EFO="True" \
#             E2E_TEST="True" \
#             docker-compose up --build -d

#             docker container run --network container:fecfile-api-proxy \
#               docker.io/jwilder/dockerize \
#               -wait http://localhost:8080/devops/status/ \
#               -wait-retry-interval 2s \
#               -timeout 60s;
#           working_directory: ~/project/fecfile-web-api

# # See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  deploy-job:
    docker:
      - image: cimg/python:3.13-node
    resource_class: large
    steps:
      - checkout

      - python/install-packages:
          pkg-manager: pip
          app-dir: ~/project/
          pip-dependency-file: requirements.txt

      - run:
          name: Install cf cli
          command: |
            mkdir -p $HOME/bin
            export PATH=$HOME/bin:$PATH
            curl -L "https://cli.run.pivotal.io/stable?release=linux64-binary&version=8.12.0" | tar xzv -C $HOME/bin

      - run:
          name: run deploy script
          no_output_timeout: 15m
          command: |
            export PATH=$HOME/bin:$PATH
            invoke deploy --branch $CIRCLE_BRANCH --login

#   dependency-check:
#     docker:
#       - image: cimg/python:3.13-node

#     steps:
#       - checkout

#       # If we need to modify the params for install-packages:
#       # https://circleci.com/developer/orbs/orb/circleci/node#commands-install-packages
#       - node/install-packages:
#           override-ci-command: npm install
#           app-dir: ~/project/front-end/
#       - run:
#           name: List installed node dependencies
#           command: npm ls --all
#           working_directory: ~/project/front-end/
#       - python/install-packages:
#           pkg-manager: pip
#           pip-dependency-file: requirements.txt
#       - run:
#           name: Check for unused dependencies
#           command: npx knip
#           working_directory: ~/project/front-end/

# # Invoke jobs via workflows
# # See: https://circleci.com/docs/2.0/configuration-reference/#workflows
# parameters:
#   is-triggered-e2e-smoke-test:
#     type: boolean
#     default: false

#   is-triggered-e2e-extended-test:
#     type: boolean
#     default: false

#   is-triggered-unit-test:
#     type: boolean
#     default: false

#   is-triggered-full-nightly:
#     type: boolean
#     default: false

workflows:
  primary:
    # when:
    #   and:
    #     - not: << pipeline.parameters.is-triggered-e2e-smoke-test >>
    #     - not: << pipeline.parameters.is-triggered-e2e-extended-test >>
    #     - not: << pipeline.parameters.is-triggered-unit-test >>
    #     - not: << pipeline.parameters.is-triggered-full-nightly >>
    jobs:
      # - lint
      # - test
      # - dependency-check
      # - e2e-smoke:
      #     filters:
      #       branches:
      #         only: /develop|release\/sprint-[\.\d]+|release\/test|main/
      - deploy-job:  # Deploy job even when e2e tests fail
          name: deploy-job
          # requires:
          #   - lint
          #   - test
          #   - dependency-check
          # filters:
          #   branches:
          #     only: /develop|release\/sprint-[\.\d]+|release\/test|main/

#   # This job is run when an e2e test is triggered with the
#   # is-triggered-e2e-test parameter via the fecfile-web-api
#   # circleci config file.  It is used to run the e2e tests
#   # when the fecfile-web-api is deployed to dev, stage,
#   # test, or prod.
#   triggered-e2e-smoke-test:
#     when: << pipeline.parameters.is-triggered-e2e-smoke-test >>
#     jobs:
#       - e2e-smoke

#   triggered-extended-e2e-test:
#     when: << pipeline.parameters.is-triggered-e2e-extended-test >>
#     jobs:
#       - e2e-extended

#   triggered-unit-test:
#     when: << pipeline.parameters.is-triggered-unit-test >>
#     jobs:
#       - test

#   full-nightly:
#     when: << pipeline.parameters.is-triggered-full-nightly >>
#     jobs:
#       - e2e-smoke
#       - e2e-extended
#       - test

#   nightly:
#     triggers:
#       - schedule:
#           cron: "0 6 * * *" # 06:00 UTC
#           filters:
#             branches:
#               only: /develop|release\/sprint-[\.\d]+|release\/test|main/
#     jobs:
#       - e2e-smoke
#       - e2e-extended
#       - test
